<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
    <meta name="description" content=""/>
    <meta name="author" content="ThemeBucket"/>
    <link rel="shortcut icon" href="#" type="image/png"/>

    <title>首页</title>

  <link href="/css/style.css" rel="stylesheet"/>
  <link href="/css/style-responsive.css" rel="stylesheet"/>

  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
    <script src="/js/html5shiv.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->

    <script type="text/javascript">
            function setToken()
            {
                var token=document.getElementById("token").innerHTML;
                if(token!="")
                document.cookie="token="+token;
            }
    </script>
    <script type="text/javascript">
        function deleteToken()
        {
            var exp = new Date();
            exp.setTime(exp.getTime() - 1);
            if(cval!=null)
                document.cookie="token="+cval+";expires="+exp.toTimeString();
        }
    </script>
    <script src="/js/voice-recorder.js"></script>
</head>

<body class="sticky-header" onload="setToken()">
<p id="token" th:text="${token}">token</p>
<section>
    <!-- left side start-->
    <div class="left-side sticky-left-side">

        <!--logo and iconic logo start-->
        <div class="logo">
            <a href="/index"><img src="/images/logo.png" alt="" /></a>
        </div>

        <div class="logo-icon text-center">
            <a href="/index"><img src="/images/logo_icon.png" alt="" /></a>
        </div>
        <!--logo and iconic logo end-->


        <div class="left-side-inner">

            <!--sidebar nav start-->
            <ul class="nav nav-pills nav-stacked custom-nav">
                <li class="active"><a href="/home"><i class="fa fa-home"></i> <span>首页</span></a></li>
                <li class="menu-list"><a href=""><i class="fa fa-laptop"></i> <span>病人管理</span></a>
                    <ul class="sub-menu-list">
                        <li><a href="/patient/today"> 今日病人</a></li>
                        <li><a href="/patient/listAll"> 全部病人</a></li>
                    </ul>
                </li>
                <li><a href="/patient/add"><i class="fa fa-bullhorn"></i> <span>新建病人</span></a></li>
                <li><a href="/disease/list"><i class="fa fa-bar-chart-o"></i> <span>疾病管理</span></a></li>
                <li><a href="/stock/list"><i class="fa fa-th-list"></i> <span>药品库存</span></a></li>
                <li><a href="/record/list"><i class="fa fa-book"></i> <span>收支记录</span></a></li>
            </ul>
            <!--sidebar nav end-->

        </div>
    </div>
    <!-- left side end-->
    
    <!-- main content start-->
    <div class="main-content" >

        <!-- header section start-->
        <div class="header-section">

            <!--toggle button start-->
            <a class="toggle-btn"><i class="fa fa-bars"></i></a>
            <!--toggle button end-->

            <!--search start-->
            <form class="searchform" action="/home" method="post">
                <input type="text" class="form-control" name="keyword" placeholder="搜索" />
            </form>
            <!--search end-->

            <!--notification menu start -->
            <div class="menu-right">
                <ul class="notification-menu">
                    <li>
                        <a href="#" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                            <img src="/images/photos/user-avatar.png" alt="" />
                            王主任
                            <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-usermenu pull-right">
                            <li><a href="profile"><i class="fa fa-user"></i>  人物简介</a></li>
                            <li><a href="#"><i class="fa fa-cog"></i>  个人设置</a></li>
                            <li onclick="deleteToken()"><a href="login"><i class="fa fa-sign-out"></i> 注销</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <!--notification menu end -->

        </div>
        <!-- header section end-->

        <!-- page heading start-->
        <div class="page-heading">
            <h3>
                MHS诊所
            </h3>
        </div>
        <!-- page heading end-->
        <!--body wrapper start-->
        <div class="wrapper">

            <div class="row">
                <div class="col-sm-12">

                    <!--price start-->
                    <div class="col-lg-3 col-sm-3">
                        <div class="pricing-table most-popular">
                            <div class="pricing-head">
                                <h1> 今日就诊数 </h1>

                            </div>
                            <div class="pricing-quote" th:text="${todayPatientNumber}">
                                38<span class="note">人次</span>
                                <p>今日</p>
                            </div>
                            <ul class="list-unstyled">
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-3 col-sm-3">
                        <div class="pricing-table">
                            <div class="pricing-head">
                                <h1> 今日收入 </h1>

                            </div>
                            <div class="pricing-quote" th:text="${todayPaymentNumber}">
                                1932<span class="note">￥</span>
                                <p>今日</p>
                            </div>
                            <ul class="list-unstyled">
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-3 col-sm-3">
                        <div class="pricing-table most-popular">
                            <div class="pricing-head">
                                <h1> 总就诊数 </h1>

                            </div>
                            <div class="pricing-quote" th:text="${allCaseHistoryNumber}">
                                496<span class="note">人次</span>
                                <p>总计</p>
                            </div>
                            <ul class="list-unstyled">
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-3 col-sm-3">
                        <div class="pricing-table">
                            <div class="pricing-head">
                                <h1> 总收入 </h1>

                            </div>
                            <div class="pricing-quote" th:text="${allPaymentNumber}">
                                2949535.16<span class="note">￥</span>
                                <p>总计</p>
                            </div>
                            <ul class="list-unstyled">
                            </ul>
                        </div>
                    </div>
                    <!--price end-->
                </div>
            </div>

        </div>
        <!--body wrapper end-->

        <!--footer section start-->
        <!--<footer class="">-->
        <!--2014 &copy; AdminEx by ThemeBucket-->
        <!--</footer>-->
        <!--footer section end-->
        <div style="display: none">
            <video src="" id="video"></video>
            <canvas id="canvas" width="720" height="720"></canvas>
        </div>

        <div class="wrapper">
            <div class="row">
                <div class="col-sm-12">

                    <div class="col-lg-3 col-sm-3">
                        <div class="pricing-table most-popular">
                            <div class="pricing-head">
                            <h1> 监控中 </h1>

                            </div>
                            <ul id="success" class="list-unstyled">
                                <li>病人ID：<span id="patient-id">暂无</span></li>
                                <li>病人姓名：<span id="patient-name">暂无</span></li>
                                <li>最后检测时间：<span id="last-connect">暂无</span></li>
                            </ul>

                            <button id="patient-detail" class="btn btn-primary" type="submit" style="margin:0 auto" disabled="disabled" onclick="queryDetail()">
                                查看详情</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <span style="white-space:pre">        </span><audio controls="autoplay"></audio>
        <input class="btn btn-primary" type="button" value="Start" onclick="startRecording()"/>
        <input class="btn btn-primary" type="submit" value="Upload" onclick="obtainRecord()"/>
        <input class="btn btn-primary" type="button" value="Stop" onclick="stopRecord()"/>
        <input class="btn btn-primary" type="button" value="Replay" onclick="playRecord()"/>
    </div>
    <!-- main content end-->
</section>

<!-- Placed js at the end of the document so the pages load faster -->
<script src="/js/jquery-1.10.2.min.js"></script>
<script src="/js/jquery-ui-1.9.2.custom.min.js"></script>
<script src="/js/jquery-migrate-1.2.1.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/modernizr.min.js"></script>
<script src="/js/jquery.nicescroll.js"></script>

<!--common scripts for all pages-->
<script src="/js/scripts.js"></script>

<script type="text/javascript" th:inline="javascript">
    /* video */
    // Prefer camera resolution nearest to 1280x720.
    var constraints = { audio: false, video: { width: 720, height: 720 } };

    navigator.mediaDevices.getUserMedia(constraints)
        .then(function(mediaStream) {
            var video = document.querySelector('video');
            video.srcObject = mediaStream;
            video.onloadedmetadata = function(e) {
                video.play();
            };
        })
        .catch(function(err) { console.log(err.name + ": " + err.message); }); // always check for errors at the end.

    var timer = setInterval ("recognize()", 3000);
    var patient_id;
    function recognize() {
        var canvans = document.getElementById("canvas"),//get canvas interface
            context = canvas.getContext("2d");
        context.drawImage(video, 0, 0, 720, 720);//draw the picture here
        var imgData = canvans.toDataURL();//get in Base64format

        var basePath = [[${#httpServletRequest.getScheme() + "://" + #httpServletRequest.getServerName() + ":" + #httpServletRequest.getServerPort() + #httpServletRequest.getContextPath()}]];

        //upload imgData here
        $.ajax({
            type: "POST",
            url: basePath + "/recognize/face",
            data: JSON.stringify({
                'image': imgData
            }),
            dataType: "json",
            contentType:"application/json;charset=utf-8",
            timeout: 3000,
            success: function (response) {

                $('#last-connect').html(response.time);

                if(response.status == "200") {
                    $('#patient-id').html(response.result.id);
                    $('#patient-name').html(response.result.name);

                    document.getElementById("patient-detail").removeAttribute("disabled");
                    patient_id = response.result.id.toString();
                    clearInterval(timer);
                }
                else{

                }

            },
            error: function () {
                clearInterval(timer);
                alert("与服务器连接错误，请刷新页面！");
            },
            complete: function () {

            }
        });
    };

    function queryDetail() {
        window.location="/patient/home/" + patient_id;
    }
</script>

<script type="text/javascript" th:inline="javascript">

    /* Audio */
    var recorder;
    var audio = document.querySelector('audio');

    function startRecording() {
        HZRecorder.get(function (rec) {
            recorder = rec;
            recorder.start();
        });
    }

    function obtainRecord(){
        var record = recorder.getBlob();
        var basePath = [[${#httpServletRequest.getScheme() + "://" + #httpServletRequest.getServerName() + ":" + #httpServletRequest.getServerPort() + #httpServletRequest.getContextPath()}]];

        recorder.upload(basePath,  function (result) {
            console.log(result);
        });
        debugger;
    };

    function stopRecord(){
        recorder.stop();
    };

    function playRecord(){
        recorder.play(audio);
    };
</script>

</body>
</html>
